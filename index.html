<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V Electronics | Manufacturing Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        /* --- PRO THEME & UI FIXES --- */
        :root {
            --glass-bg: rgba(10, 15, 30, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --highlight: #3b82f6;
            --accent: #06b6d4;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #02040a; 
            color: #f8fafc; 
            overflow: hidden;
        }

        /* Animated Mesh Background */
        .cyber-grid {
            position: absolute; inset: 0; pointer-events: none; z-index: 0;
            background-image: linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }

        .cyber-bg {
            background-color: #02040a;
            background-image: radial-gradient(circle at 50% 0%, #172554 0%, transparent 50%);
        }

        /* Ultra Glass Components */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* FIXED: Range Sliders (Visibility High) */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 30px;
            cursor: pointer;
            margin: 5px 0;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
            border: 1px solid #334155;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            margin-top: -7px;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* Interactive Elements */
        .pro-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            transition: all 0.2s ease;
        }
        .pro-input:focus { border-color: var(--highlight); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25); outline: none; background: rgba(0,0,0,0.6); }
        
        .pro-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            position: relative; overflow: hidden;
        }
        .pro-btn:hover { background: rgba(255,255,255,0.1); border-color: white; }
        .pro-btn:active { transform: scale(0.98); }

        /* Feature Cards Grid */
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; }
        .feature-card {
            position: relative; cursor: pointer;
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s;
        }
        .feature-card:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); }
        .feature-card input:checked + div { background: rgba(59, 130, 246, 0.15); border-color: #3b82f6; }
        .feature-card input:checked + div span { color: #60a5fa; font-weight: 600; }

        /* Cost Chart Bar */
        .cost-bar { height: 6px; border-radius: 3px; overflow: hidden; display: flex; width: 100%; margin-top: 8px; background: #0f172a; }
        .cost-seg { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Utils */
        .mono { font-family: 'JetBrains Mono', monospace; }
        .drop-active { border-color: var(--highlight) !important; background: rgba(59, 130, 246, 0.1) !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(180deg); }

        @media (max-width: 768px) {
            #view-configurator { flex-direction: column; }
            #drop-zone { height: 40vh; flex-shrink: 0; }
            #sidebar { flex: 1; }
            body { overflow-y: auto; }
        }
    </style>
</head>
<body class="h-screen w-full relative bg-[#02040a]">

    <div id="view-configurator" class="w-full h-full flex flex-col md:flex-row relative z-10 transition-transform duration-500 ease-in-out">
        
        <div class="relative w-full md:w-3/4 h-[50vh] md:h-full group bg-gradient-to-b from-[#0f172a]/20 to-[#02040a]" id="drop-zone">
            <div class="cyber-grid"></div>
            <div id="canvas-container" class="w-full h-full cursor-move relative z-0"></div>
            
            <div class="absolute top-6 right-6 flex flex-col gap-2 pointer-events-auto z-20">
                <button id="btn-snapshot" class="glass-panel w-10 h-10 rounded-lg flex items-center justify-center hover:bg-white/10 text-slate-300 hover:text-white transition" title="Take Snapshot">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                </button>
                <button id="btn-grid" class="glass-panel w-10 h-10 rounded-lg flex items-center justify-center hover:bg-white/10 text-slate-300 hover:text-white transition" title="Toggle Grid">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                </button>
                <button id="btn-slicer" class="glass-panel w-10 h-10 rounded-lg flex items-center justify-center hover:bg-white/10 text-slate-300 hover:text-white transition" title="X-Ray / Slicer">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </button>
            </div>

            <div id="slicer-controls" class="absolute top-6 right-20 w-48 glass-panel p-4 rounded-xl hidden transition-all z-20">
                <label class="text-[10px] text-blue-400 uppercase font-bold block mb-2">X-Ray Slicing Height</label>
                <input type="range" id="slice-slider" min="0" max="100" value="100" class="w-full">
            </div>

            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-3 pointer-events-auto z-20 glass-panel p-1.5 rounded-full border border-white/10">
                <button id="btn-wireframe" class="px-4 py-2 rounded-full text-xs font-medium hover:bg-white/10 text-slate-300 transition flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-slate-500"></span> Wireframe
                </button>
                <button id="btn-reset-view" class="px-4 py-2 rounded-full text-xs font-medium hover:bg-white/10 text-slate-300 transition">Reset Cam</button>
                <button id="btn-rotate" class="px-4 py-2 rounded-full text-xs font-medium bg-blue-600 text-white shadow-[0_0_20px_rgba(37,99,235,0.5)] hover:bg-blue-500 transition flex items-center gap-2">
                    <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Auto-Spin
                </button>
            </div>

            <div class="absolute top-6 left-6 pointer-events-none z-20">
                <div class="glass-panel px-5 py-4 rounded-2xl border-l-4 border-blue-500 space-y-3 shadow-2xl">
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Bounding Box</span>
                        <span id="hud-dims" class="mono text-sm text-white block mt-1">0 x 0 x 0 mm</span>
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">Volume</span>
                        <span id="hud-vol" class="mono text-sm text-white block mt-1">0.00 cm¬≥</span>
                    </div>
                </div>
            </div>

            <div id="loader-3d" class="hidden absolute inset-0 bg-black/80 flex items-center justify-center z-50 backdrop-blur-md">
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4 shadow-[0_0_30px_#2563eb]"></div>
                    <span class="text-xs tracking-[0.3em] text-blue-500 font-bold animate-pulse">ANALYZING GEOMETRY</span>
                </div>
            </div>

            <div id="drag-hint" class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 bg-blue-900/20 backdrop-blur-sm border-2 border-dashed border-blue-500 m-8 rounded-3xl z-40">
                <h2 class="text-3xl font-bold text-white tracking-widest drop-shadow-lg">DROP STL FILE HERE</h2>
            </div>
        </div>

        <div class="w-full md:w-1/4 glass-panel border-l border-white/5 flex flex-col h-full z-30 shadow-2xl relative" id="sidebar">
            
            <div class="p-5 border-b border-white/5 flex items-center gap-4 bg-gradient-to-r from-slate-900/80 to-transparent">
                <img src="assets/VLOGO.jpg" alt="V" class="w-10 h-10 rounded-lg shadow-lg ring-1 ring-white/10 object-cover bg-white">
                <div>
                    <h1 class="font-bold text-white text-lg tracking-tight leading-none">V ELECTRONICS</h1>
                    <p class="text-[10px] text-blue-400 uppercase tracking-widest mt-1">Manufacturing Hub</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scrollbar-hide p-5 space-y-4">
                
                <div class="relative group mb-2">
                    <input type="file" id="file-input" accept=".stl" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                    <div class="pro-input py-6 px-4 rounded-xl flex flex-col items-center justify-center gap-2 group-hover:border-blue-500 border-dashed border-2 border-slate-600 bg-slate-900/40 transition-colors">
                        <svg class="w-6 h-6 text-slate-400 group-hover:text-blue-400 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span id="filename-display" class="text-xs text-slate-300 font-medium truncate max-w-[200px]">Click or Drag STL File</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <button class="pro-btn py-2.5 rounded-lg text-xs font-bold text-slate-300 hover:text-white" onclick="applyPreset('proto')">
                        <span class="block text-blue-400 text-[10px] font-normal mb-0.5">CHEAPEST</span>
                        üöÄ Prototype
                    </button>
                    <button class="pro-btn py-2.5 rounded-lg text-xs font-bold text-slate-300 hover:text-white" onclick="applyPreset('strong')">
                        <span class="block text-green-400 text-[10px] font-normal mb-0.5">DURABLE</span>
                        üí™ Strong
                    </button>
                </div>

                <details open class="group bg-white/5 rounded-lg border border-white/5">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-white/5 transition rounded-t-lg">
                        <span class="text-xs font-bold text-slate-200 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                            Scale & Orient
                        </span>
                        <svg class="w-4 h-4 text-slate-500 arrow transition-transform duration-200" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-3 pt-0 space-y-4">
                        <div class="bg-black/20 p-2 rounded-lg mt-2">
                            <div class="flex justify-between mb-2 items-center">
                                <span class="text-[10px] text-slate-400 uppercase font-bold">Scale Factor</span>
                                <span id="scale-display" class="text-xs font-mono font-bold text-blue-400 bg-blue-900/30 px-2 py-0.5 rounded">100%</span>
                            </div>
                            <input type="range" id="scale-sel" min="0.1" max="3.0" step="0.05" value="1.0">
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="pro-btn py-2 rounded text-[10px] text-slate-400 hover:text-white" onclick="rotateMesh('x')">Rot X 90¬∞</button>
                            <button class="pro-btn py-2 rounded text-[10px] text-slate-400 hover:text-white" onclick="rotateMesh('y')">Rot Y 90¬∞</button>
                            <button class="pro-btn py-2 rounded text-[10px] text-slate-400 hover:text-white" onclick="rotateMesh('z')">Rot Z 90¬∞</button>
                        </div>
                    </div>
                </details>

                <details open class="group bg-white/5 rounded-lg border border-white/5">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-white/5 transition rounded-t-lg">
                        <span class="text-xs font-bold text-slate-200 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            Material Specs
                        </span>
                        <svg class="w-4 h-4 text-slate-500 arrow transition-transform duration-200" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-3 pt-0 space-y-3">
                        <div class="flex gap-2 mt-2">
                            <div class="w-16">
                                <label class="text-[9px] text-slate-500 uppercase block mb-1">Qty</label>
                                <input type="number" id="qty-input" value="1" min="1" class="pro-input w-full p-2 rounded text-xs text-center font-bold">
                            </div>
                            <div class="flex-1">
                                <label class="text-[9px] text-slate-500 uppercase block mb-1">Type</label>
                                <select id="material-sel" class="pro-input w-full p-2 rounded text-xs appearance-none">
                                    <option value="PLA">PLA (Eco-Friendly)</option>
                                    <option value="PETG">PETG (Tough & Heat)</option>
                                    <option value="ABS">ABS (Industrial)</option>
                                    <option value="TPU">TPU (Flexible)</option>
                                    <option value="CF">Carbon Fiber Nylon</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[9px] text-slate-500 uppercase block mb-1">Strength</label>
                                <select id="strength-sel" class="pro-input w-full p-2 rounded text-xs">
                                    <option value="decorative">Standard Walls</option>
                                    <option value="structural">Structural (+)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] text-slate-500 uppercase block mb-1">Finish</label>
                                <select id="finish-sel" class="pro-input w-full p-2 rounded text-xs">
                                    <option value="raw">Raw Finish</option>
                                    <option value="sanded">Sanded</option>
                                    <option value="painted">Painted</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-black/20 p-2 rounded-lg">
                            <div class="flex justify-between mb-1">
                                <span class="text-[10px] text-slate-400 uppercase font-bold">Infill Density</span>
                                <span id="infill-display" class="text-xs font-mono font-bold text-blue-400 bg-blue-900/30 px-2 py-0.5 rounded">20%</span>
                            </div>
                            <input type="range" id="infill-sel" min="10" max="100" step="5" value="20" class="block w-full">
                            
                            <div class="mt-2 pt-2 border-t border-white/5">
                                <label class="text-[9px] text-slate-400 uppercase font-bold block mb-1">Infill Pattern {6}</label>
                                <select id="pattern-sel" class="pro-input w-full p-1.5 rounded text-xs">
                                    <option value="grid">Grid (Standard)</option>
                                    <option value="gyroid">Gyroid (3D Strength)</option>
                                    <option value="honeycomb">Honeycomb (Strong)</option>
                                    <option value="triangles">Triangles (Rigid)</option>
                                    <option value="cubic">Cubic (Balanced)</option>
                                    <option value="concentric">Concentric (Flexible)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <span class="text-[9px] text-slate-500 uppercase block mb-2">Color</span>
                            <div class="flex flex-wrap gap-3" id="color-picker"></div>
                        </div>
                    </div>
                </details>

                <details class="group bg-white/5 rounded-lg border border-white/5">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-white/5 transition rounded-t-lg">
                        <span class="text-xs font-bold text-slate-200 uppercase tracking-wider flex items-center gap-2">
                            <svg class="w-4 h-4 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            Pro Add-ons
                        </span>
                        <svg class="w-4 h-4 text-slate-500 arrow transition-transform duration-200" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="p-3 pt-0 mt-2">
                        <div class="feature-grid">
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-supports" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üå≥</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Supports</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-inserts" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üî©</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Inserts</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-uv" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">‚òÄÔ∏è</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">UV Coat</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-epoxy" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üíß</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Epoxy</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-vapor" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üí®</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Vapor</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-rush" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-orange-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">‚ö°</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-orange-400 font-bold">Priority</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-cert" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üìú</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Mat. Cert</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-report" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üìè</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Dim. Rpt</span>
                                </div>
                            </label>
                            <label class="feature-card rounded p-2 flex flex-col gap-1 items-center text-center">
                                <input type="checkbox" id="check-sandblast" class="peer sr-only">
                                <div class="w-full h-full rounded border border-transparent peer-checked:border-blue-500 bg-slate-800/50 p-2 transition-colors">
                                    <span class="text-lg">üå™Ô∏è</span>
                                    <span class="text-[9px] text-slate-400 block mt-1 peer-checked:text-blue-400 font-bold">Blast</span>
                                </div>
                            </label>
                        </div>
                        
                        <div class="hidden">
                            <input type="checkbox" id="check-adhesion">
                            <input type="checkbox" id="check-assembly">
                            <input type="checkbox" id="check-repair">
                            <input type="checkbox" id="check-hardware">
                            <input type="checkbox" id="check-branding">
                            <input type="checkbox" id="check-privacy">
                            <input type="checkbox" id="check-qc">
                            <select id="tolerance-sel"><option value="std"></option></select>
                        </div>
                    </div>
                </details>
            </div>

            <div class="bg-slate-900/95 border-t border-white/10 backdrop-blur-xl p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-40">
                <div class="mb-4">
                    <div class="flex justify-between text-[10px] text-slate-500 mb-1 uppercase font-bold tracking-wider">
                        <span>Material</span><span>Machine</span><span>Labor</span>
                    </div>
                    <div class="cost-bar bg-slate-800">
                        <div id="bar-mat" class="cost-seg bg-blue-500" style="width: 0%"></div>
                        <div id="bar-mac" class="cost-seg bg-purple-500" style="width: 0%"></div>
                        <div id="bar-lab" class="cost-seg bg-green-500" style="width: 0%"></div>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-4">
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase tracking-widest">Total Estimate</span>
                        <span id="est-price" class="text-3xl font-bold text-white tracking-tighter block mt-1">‚Çπ0</span>
                    </div>
                    <div class="text-right">
                        <span id="est-time" class="text-sm font-mono text-blue-400 font-bold block bg-blue-900/20 px-2 rounded mb-1">0h 0m</span>
                        <span id="footer-weight" class="text-[10px] text-slate-500 block font-mono">0g</span>
                    </div>
                </div>

                <button id="btn-goto-cart" disabled class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(37,99,235,0.4)] transition-all disabled:opacity-50 disabled:cursor-not-allowed uppercase tracking-widest text-xs flex items-center justify-center gap-2 group border border-blue-400/30">
                    <span>Review Order</span>
                    <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="view-checkout" class="hidden fixed inset-0 z-50 bg-[#02040a] overflow-y-auto cyber-bg transition-opacity duration-300">
        <div class="cyber-grid fixed"></div> <div class="max-w-7xl mx-auto p-4 md:p-8 min-h-full flex flex-col relative z-10">
            
            <div class="flex justify-between items-center mb-8 border-b border-white/10 pb-6 bg-[#02040a]/80 backdrop-blur-xl sticky top-0 z-20 py-4 px-2 rounded-b-2xl">
                <div class="flex items-center gap-4">
                    <img src="assets/VLOGO.jpg" class="w-14 h-14 rounded-xl shadow-lg border border-white/10">
                    <div>
                        <h1 class="text-2xl font-bold text-white tracking-wide">CHECKOUT</h1>
                        <p class="text-[10px] text-blue-400 uppercase tracking-widest font-bold">V Electronics Pvt Ltd</p>
                    </div>
                </div>
                <button id="btn-back" class="glass-panel px-5 py-2 rounded-full text-xs font-bold hover:bg-white/10 text-slate-300 transition flex items-center gap-2 border border-white/10">
                    <span>‚Üê Edit</span>
                </button>
            </div>

            <div class="grid lg:grid-cols-12 gap-8 flex-1">
                <div class="lg:col-span-7 space-y-6">
                    
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-blue-600 shadow-2xl">
                         <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Service Provider Info</h3>
                         <div class="flex flex-col md:flex-row justify-between gap-4">
                            <div>
                                <h4 class="text-white font-bold text-lg">V ELECTRONICS PVT LTD</h4>
                                <p class="text-sm text-slate-400">Warehouse #12, Dighi, Pune - 411015</p>
                            </div>
                            <div class="text-right text-sm">
                                <p class="text-blue-400 font-mono">+91 7892719496</p>
                                <p class="text-slate-500">care.invelectronicspvtltd@gmail.com</p>
                            </div>
                         </div>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl border border-white/5">
                        <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-6 h-6 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400 border border-blue-500/30">1</span>
                            Dispatch Warehouse
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <label class="cursor-pointer relative">
                                <input type="radio" name="warehouse" value="Pune" checked class="peer sr-only">
                                <div class="p-4 rounded-xl border border-slate-700 bg-slate-900/50 hover:bg-slate-800 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm text-white">Pune HQ</div>
                                        <div class="text-[10px] text-green-400">Available</div>
                                    </div>
                                    <div class="w-4 h-4 rounded-full border border-slate-500 peer-checked:bg-blue-500"></div>
                                </div>
                            </label>
                            <label class="cursor-pointer relative">
                                <input type="radio" name="warehouse" value="Mulbagal" class="peer sr-only">
                                <div class="p-4 rounded-xl border border-slate-700 bg-slate-900/50 hover:bg-slate-800 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-sm text-white">Ganesh Ent. Mulbagal</div>
                                        <div class="text-[10px] text-blue-400">Partner Facility</div>
                                    </div>
                                    <div class="w-4 h-4 rounded-full border border-slate-500 peer-checked:bg-blue-500"></div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl border border-white/5">
                        <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                            <span class="w-6 h-6 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400 border border-blue-500/30">2</span>
                            Shipping & Business Details
                        </h3>
                        <form id="checkout-form" class="space-y-4">
                            <div class="grid md:grid-cols-2 gap-4">
                                <input type="text" name="name" required placeholder="Contact Person Name" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500">
                                <input type="tel" name="phone" required placeholder="Mobile Number" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500">
                            </div>
                            <input type="email" name="email" required placeholder="Email Address" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500">
                            
                            <div class="grid md:grid-cols-2 gap-4 border-t border-white/5 pt-4 mt-2">
                                <input type="text" name="company" placeholder="Company Name (Optional)" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500">
                                <input type="text" name="gstin" placeholder="GSTIN (If Applicable)" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500 uppercase">
                            </div>
                            <div class="grid md:grid-cols-2 gap-4">
                                <input type="text" name="po_ref" placeholder="Project / PO Reference ID" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500">
                                <input type="date" name="target_date" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500 text-slate-400">
                            </div>

                            <textarea name="address" rows="3" required placeholder="Shipping Address with Pincode" class="pro-input w-full p-4 rounded-xl text-sm placeholder-slate-500"></textarea>
                            <textarea id="custom-msg" rows="2" placeholder="Special Manufacturing Notes..." class="pro-input w-full p-4 rounded-xl text-sm border-dashed border-slate-600 placeholder-slate-500"></textarea>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-5">
                    <div class="glass-panel p-6 rounded-2xl sticky top-24 border-t-4 border-green-500 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                        <h3 class="text-lg font-bold text-white mb-6 tracking-wide">ORDER SUMMARY</h3>
                        
                        <div class="bg-slate-800/40 rounded-xl p-4 mb-6 flex gap-4 border border-white/5">
                            <div class="w-14 h-14 bg-blue-600/20 rounded-lg flex items-center justify-center text-blue-400 border border-blue-500/20">
                                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                            </div>
                            <div class="flex-1 overflow-hidden">
                                <div id="cart-file" class="font-bold text-sm text-white truncate">Loading...</div>
                                <div id="cart-specs" class="text-xs text-slate-400 mt-1 space-y-1"></div>
                            </div>
                        </div>

                        <div id="cart-addons" class="mb-6 space-y-1 text-xs text-slate-400 border-b border-white/5 pb-4 empty:hidden"></div>

                        <div class="space-y-3 text-sm border-b border-white/10 pb-6 mb-6">
                            <div class="flex justify-between text-slate-400"><span>Manufacturing</span><span id="bill-sub" class="text-white font-mono">‚Çπ0</span></div>
                            <div class="flex justify-between text-slate-400"><span>Shipping</span><span id="bill-ship" class="text-white font-mono">‚Çπ0</span></div>
                            <div class="flex justify-between text-blue-400 mt-2 font-mono text-xs bg-blue-900/10 p-2 rounded"><span>Est. Production Time</span><span id="bill-time" class="font-bold">-</span></div>
                        </div>
                        
                        <div class="flex justify-between items-end mb-8">
                            <span class="text-slate-300 font-bold text-sm uppercase tracking-widest">Total Pay</span>
                            <span id="bill-total" class="text-4xl font-bold text-white tracking-tighter text-shadow-lg">‚Çπ0</span>
                        </div>
                        
                        <div class="mb-6">
                            <label class="text-[10px] text-slate-400 uppercase font-bold block mb-2">Select Payment Method</label>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <label class="cursor-pointer">
                                    <input type="radio" name="pay-method" value="UPI" checked class="peer sr-only" onchange="togglePayment('UPI')">
                                    <div class="p-3 rounded-lg border border-slate-600 bg-slate-900 text-center peer-checked:bg-blue-600 peer-checked:border-blue-400 transition hover:bg-slate-800">
                                        <span class="text-xs font-bold text-white">üì≤ UPI Online</span>
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="pay-method" value="COD" class="peer sr-only" onchange="togglePayment('COD')">
                                    <div class="p-3 rounded-lg border border-slate-600 bg-slate-900 text-center peer-checked:bg-blue-600 peer-checked:border-blue-400 transition hover:bg-slate-800">
                                        <span class="text-xs font-bold text-white">üöö COD</span>
                                    </div>
                                </label>
                            </div>

                            <div id="upi-section" class="bg-white p-4 rounded-xl text-center shadow-lg relative overflow-hidden group">
                                <canvas id="qr-code" class="mx-auto relative z-10"></canvas>
                                <p class="text-[10px] text-slate-900 mt-2 font-bold tracking-widest relative z-10">SCAN TO PAY</p>
                                <input type="text" id="utr-input" placeholder="Enter UTR / Transaction ID" class="w-full mt-3 p-2 bg-slate-100 border border-slate-300 rounded text-slate-900 text-xs font-mono text-center focus:outline-none focus:border-blue-500 relative z-10">
                            </div>

                            <div id="cod-section" class="hidden bg-slate-800/50 p-4 rounded-xl text-center border border-dashed border-slate-500">
                                <p class="text-xs text-slate-300">Pay cash/UPI to the delivery agent upon arrival.</p>
                            </div>
                        </div>
                        
                        <button id="btn-place-order" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-[0_0_25px_rgba(22,163,74,0.4)] transition uppercase tracking-wide text-sm flex items-center justify-center gap-2">
                            <span>Confirm & Upload</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                        <p id="error-log" class="text-center text-xs text-red-400 mt-4 hidden bg-red-900/20 p-2 rounded border border-red-500/30"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { PRICING, calculateMetrics, db, storage } from './config.js';
        import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // APP STATE (Expanded)
        let STATE = {
            file: null, baseVolume: 0, baseArea: 0,
            weight: 0, cost: 0, time: 0, shipping: 0,
            material: 'PLA', quality: 'std', infill: 20, color: '#3b82f6', infillPattern: 'grid',
            scale: 1.0, qty: 1, finish: 'raw', strength: 'decorative', tolerance: 'std',
            hasSupports: false, hasAdhesion: false, isRush: false, isQC: false,
            isEpoxy: false, isVapor: false, isHardware: false, isRemoveBrand: false, isPrivacy: false,
            isInserts: false, isUV: false, isAssembly: false, isRepair: false,
            isCert: false, isReport: false, isSandblast: false, // New States
            autoRotate: true
        };

        // Payment Toggle Logic (Global Scope)
        window.togglePayment = (method) => {
            if(method === 'UPI') {
                document.getElementById('upi-section').classList.remove('hidden');
                document.getElementById('cod-section').classList.add('hidden');
            } else {
                document.getElementById('upi-section').classList.add('hidden');
                document.getElementById('cod-section').classList.remove('hidden');
            }
        };

        // THREEJS SETUP
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(60, 60, 90);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true }); 
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.localClippingEnabled = true; 
        container.appendChild(renderer.domElement);

        // LIGHTING (Studio)
        scene.add(new THREE.AmbientLight(0xffffff, 0.4));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
        dirLight.position.set(50, 100, 50); dirLight.castShadow = true; scene.add(dirLight);
        const rimLight = new THREE.DirectionalLight(0x3b82f6, 0.8);
        rimLight.position.set(-50, 20, -50); scene.add(rimLight);

        // GRID
        const grid = new THREE.GridHelper(200, 40, 0x3b82f6, 0x1e293b);
        grid.material.transparent = true; grid.material.opacity = 0.15;
        scene.add(grid);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.autoRotate = STATE.autoRotate;

        // MATERIAL & CLIPPING
        const clipPlane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 100);
        const mat = new THREE.MeshStandardMaterial({ 
            color: STATE.color, roughness: 0.4, metalness: 0.1, 
            clippingPlanes: [clipPlane], clipShadows: true, side: THREE.DoubleSide
        });
        const wireMat = new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.1 });

        let mesh = null; let wireframe = null; let supportGroup = null;

        // TREE SUPPORTS
        function generateTreeSupports(mesh) {
            const box = new THREE.Box3().setFromObject(mesh);
            const size = new THREE.Vector3(); box.getSize(size);
            const center = new THREE.Vector3(); box.getCenter(center);
            const group = new THREE.Group();
            const mat = new THREE.LineBasicMaterial({ color: 0x22c55e, opacity: 0.5, transparent: true }); 
            const trunkCount = Math.max(5, Math.floor((size.x * size.z) / 100)); 
            for(let i=0; i<trunkCount; i++) {
                const startX = center.x + (Math.random() - 0.5) * size.x * 0.9;
                const startZ = center.z + (Math.random() - 0.5) * size.z * 0.9;
                const start = new THREE.Vector3(startX, -mesh.position.y, startZ); 
                const endY = box.min.y + (Math.random() * size.y * 0.5); 
                const endX = startX + (Math.random() - 0.5) * size.x * 0.2; 
                const endZ = startZ + (Math.random() - 0.5) * size.z * 0.2;
                const end = new THREE.Vector3(endX, endY, endZ);
                const mid = new THREE.Vector3().lerpVectors(start, end, 0.5);
                mid.x += (Math.random() - 0.5) * size.x * 0.4; mid.z += (Math.random() - 0.5) * size.z * 0.4;
                const curve = new THREE.CatmullRomCurve3([start, mid, end]);
                const points = curve.getPoints(10);
                const geom = new THREE.BufferGeometry().setFromPoints(points);
                group.add(new THREE.Line(geom, mat));
            }
            return group;
        }

        function toggleSupportVis(visible) {
            if(!mesh) return;
            if(supportGroup) scene.remove(supportGroup);
            if(visible) { supportGroup = generateTreeSupports(mesh); scene.add(supportGroup); }
        }

        window.rotateMesh = (axis) => { 
            if(mesh) { 
                mesh.rotation[axis] += Math.PI/2; if(wireframe) wireframe.rotation[axis] += Math.PI/2;
                const box = new THREE.Box3().setFromObject(mesh);
                const yOffset = -box.min.y;
                mesh.position.y += yOffset; if(wireframe) wireframe.position.y += yOffset;
                if(STATE.hasSupports) toggleSupportVis(true);
            } 
        };

        window.applyPreset = (type) => {
            if(type === 'proto') {
                document.getElementById('material-sel').value = 'PLA';
                document.getElementById('infill-sel').value = 15;
                STATE.material = 'PLA'; STATE.infill = 15;
            } else if(type === 'strong') {
                document.getElementById('material-sel').value = 'PETG';
                document.getElementById('infill-sel').value = 50;
                document.getElementById('strength-sel').value = 'structural';
                STATE.material = 'PETG'; STATE.infill = 50; STATE.strength = 'structural';
            }
            document.getElementById('infill-display').innerText = STATE.infill + '%';
            updateEstimates();
        };

        function updateEstimates() {
            const metrics = calculateMetrics(STATE.baseVolume, STATE.baseArea, STATE.infill, STATE.material, STATE.quality, {
                scale: STATE.scale, qty: STATE.qty, strength: STATE.strength, finish: STATE.finish, tolerance: STATE.tolerance,
                supports: STATE.hasSupports, adhesion: STATE.hasAdhesion, rush: STATE.isRush, qc: STATE.isQC,
                epoxy: STATE.isEpoxy, vapor: STATE.isVapor, hardware: STATE.isHardware, removeBrand: STATE.isRemoveBrand,
                inserts: STATE.isInserts, uv: STATE.isUV, assembly: STATE.isAssembly, repair: STATE.isRepair,
                cert: STATE.isCert, report: STATE.isReport, sandblast: STATE.isSandblast // New Flags
            });
            
            STATE.weight = metrics.weight; STATE.cost = metrics.totalCost; STATE.shipping = metrics.shippingCost; STATE.time = metrics.timeHours;

            const hrs = Math.floor(STATE.time); const mins = Math.round((STATE.time - hrs) * 60);
            
            if(document.getElementById('footer-weight')) document.getElementById('footer-weight').innerText = STATE.weight.toFixed(0) + 'g';
            if(document.getElementById('est-time')) document.getElementById('est-time').innerText = `${hrs}h ${mins}m`;
            if(document.getElementById('est-price')) document.getElementById('est-price').innerText = '‚Çπ' + STATE.cost;
            if(document.getElementById('btn-goto-cart')) document.getElementById('btn-goto-cart').disabled = STATE.cost === 0;

            const total = metrics.breakdown.material + metrics.breakdown.machine + metrics.breakdown.labor;
            const pctMat = total > 0 ? (metrics.breakdown.material / total) * 100 : 0;
            const pctMac = total > 0 ? (metrics.breakdown.machine / total) * 100 : 0;
            const pctLab = total > 0 ? (metrics.breakdown.labor / total) * 100 : 0;
            
            document.getElementById('bar-mat').style.width = pctMat + '%';
            document.getElementById('bar-mac').style.width = pctMac + '%';
            document.getElementById('bar-lab').style.width = pctLab + '%';
        }

        function populateCheckout() {
            const hrs = Math.floor(STATE.time); const mins = Math.round((STATE.time - hrs) * 60);

            document.getElementById('bill-sub').innerText = '‚Çπ' + (STATE.cost - STATE.shipping);
            document.getElementById('bill-total').innerText = '‚Çπ' + STATE.cost;
            document.getElementById('bill-time').innerText = `${hrs}h ${mins}m`;
            
            const shipElem = document.getElementById('bill-ship');
            shipElem.innerHTML = STATE.shipping === 0 ? `<span class="text-green-400 font-bold">FREE</span>` : '‚Çπ' + STATE.shipping;

            document.getElementById('cart-specs').innerHTML = `
                <div class="flex justify-between"><span>Material:</span> <span class="text-white">${PRICING.materials[STATE.material].name}</span></div>
                <div class="flex justify-between"><span>Quantity:</span> <span class="text-white">${STATE.qty} Unit(s)</span></div>
                <div class="flex justify-between"><span>Infill:</span> <span class="text-white">${STATE.infill}% (${STATE.infillPattern})</span></div>
                <div class="flex justify-between"><span>Weight:</span> <span class="text-white">${STATE.weight.toFixed(0)}g</span></div>
            `;

            const addonsDiv = document.getElementById('cart-addons');
            addonsDiv.innerHTML = '';
            const activeAddons = [];
            if(STATE.hasSupports) activeAddons.push('Tree Supports');
            if(STATE.isRush) activeAddons.push('‚ö° Rush Production');
            if(STATE.isVapor) activeAddons.push('Vapor Smoothing');
            if(STATE.isEpoxy) activeAddons.push('Epoxy Coating');
            if(STATE.isInserts) activeAddons.push('Heat-Set Inserts');
            if(STATE.finish !== 'raw') activeAddons.push(`${STATE.finish.toUpperCase()} Finish`);
            // New Addons listing
            if(STATE.isCert) activeAddons.push('Material Certificate');
            if(STATE.isReport) activeAddons.push('Dimensional Report');
            if(STATE.isSandblast) activeAddons.push('Sandblasting');

            if(activeAddons.length > 0) {
                addonsDiv.classList.remove('hidden');
                activeAddons.forEach(addon => {
                    addonsDiv.innerHTML += `<div class="flex items-center gap-2"><span class="text-blue-500">‚úì</span> ${addon}</div>`;
                });
            } else {
                addonsDiv.classList.add('hidden');
            }

            new QRious({ element: document.getElementById('qr-code'), value: `upi://pay?pa=${PRICING.upiId}&pn=${encodeURIComponent(PRICING.upiName)}&am=${STATE.cost}&cu=INR`, size: 180 });
        }

        function loadSTL(arrayBuffer, fileName) {
            const loader = new STLLoader();
            try {
                const geom = loader.parse(arrayBuffer);
                if(mesh) { scene.remove(mesh); scene.remove(wireframe); if(supportGroup) scene.remove(supportGroup); mesh.geometry.dispose(); }
                geom.computeBoundingBox();
                const box = geom.boundingBox; const center = new THREE.Vector3(); box.getCenter(center); const size = new THREE.Vector3(); box.getSize(size);
                
                if(size.y < 2) { 
                    geom.scale(10,10,10); geom.computeBoundingBox(); box.getCenter(center); box.getSize(size); 
                }
                
                geom.translate(-center.x, -center.y + (size.y/2), -center.z);
                
                let vol = 0; const pos = geom.attributes.position; const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
                for(let i=0; i<pos.count; i+=3){ p1.fromBufferAttribute(pos, i); p2.fromBufferAttribute(pos, i+1); p3.fromBufferAttribute(pos, i+2); vol += p1.dot(p2.cross(p3)) / 6.0; }
                
                STATE.baseVolume = Math.abs(vol) / 1000; 
                STATE.baseArea = STATE.baseVolume * 6;

                mesh = new THREE.Mesh(geom, mat); mesh.castShadow = true; mesh.receiveShadow = true; scene.add(mesh);
                
                const edges = new THREE.EdgesGeometry(geom, 35); wireframe = new THREE.LineSegments(edges, wireMat); scene.add(wireframe);

                const maxY = size.y;
                document.getElementById('slice-slider').max = maxY;
                document.getElementById('slice-slider').min = 0;
                document.getElementById('slice-slider').value = maxY;
                clipPlane.constant = maxY;

                const maxDim = Math.max(size.x, size.y, size.z); const dist = maxDim * 2.5; camera.position.set(dist, dist, dist); controls.target.set(0, size.y/2, 0); controls.update();

                document.getElementById('hud-dims').innerText = `${size.x.toFixed(0)}x${size.y.toFixed(0)}x${size.z.toFixed(0)}mm`;
                document.getElementById('hud-vol').innerText = STATE.baseVolume.toFixed(2) + ' cm¬≥';
                updateEstimates();
            } catch(e) { console.error(e); alert("Invalid STL File"); }
        }

        const id = (i) => document.getElementById(i);
        const fileInput = id('file-input');
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return; STATE.file = file; id('filename-display').innerText = file.name; id('cart-file').innerText = file.name; id('loader-3d').classList.remove('hidden');
            const reader = new FileReader(); reader.onload = (e) => { loadSTL(e.target.result, file.name); id('loader-3d').classList.add('hidden'); }; reader.readAsArrayBuffer(file);
        });

        const dropZone = id('drop-zone'); const dragHint = id('drag-hint');
        ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dragHint.style.opacity = "1"; dropZone.classList.add('drop-active'); }));
        ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dragHint.style.opacity = "0"; dropZone.classList.remove('drop-active'); }));
        dropZone.addEventListener('drop', (e) => { const dt = e.dataTransfer; if(dt.files.length > 0 && dt.files[0].name.toLowerCase().endsWith('.stl')) { STATE.file = dt.files[0]; id('filename-display').innerText = STATE.file.name; id('cart-file').innerText = STATE.file.name; id('loader-3d').classList.remove('hidden'); const reader = new FileReader(); reader.onload = (e) => { loadSTL(e.target.result, STATE.file.name); id('loader-3d').classList.add('hidden'); }; reader.readAsArrayBuffer(STATE.file); } });

        id('btn-grid').addEventListener('click', () => { grid.visible = !grid.visible; });
        id('btn-slicer').addEventListener('click', () => { id('slicer-controls').classList.toggle('hidden'); });
        id('btn-snapshot').addEventListener('click', () => {
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a'); link.download = 'snapshot.png'; link.href = dataURL; link.click();
        });
        
        id('slice-slider').addEventListener('input', (e) => { clipPlane.constant = parseFloat(e.target.value); });
        id('material-sel').addEventListener('change', (e) => { STATE.material = e.target.value; updateEstimates(); });
        id('infill-sel').addEventListener('input', (e) => { STATE.infill = parseInt(e.target.value); id('infill-display').innerText = STATE.infill + '%'; updateEstimates(); });
        // NEW: Pattern Listener
        id('pattern-sel').addEventListener('change', (e) => { STATE.infillPattern = e.target.value; updateEstimates(); });
        
        id('scale-sel').addEventListener('input', (e) => { STATE.scale = parseFloat(e.target.value); id('scale-display').innerText = Math.round(STATE.scale*100) + '%'; if(mesh) { mesh.scale.setScalar(STATE.scale); wireframe.scale.setScalar(STATE.scale); } updateEstimates(); });
        id('qty-input').addEventListener('change', (e) => { STATE.qty = parseInt(e.target.value); updateEstimates(); });
        id('finish-sel').addEventListener('change', (e) => { STATE.finish = e.target.value; updateEstimates(); });
        id('strength-sel').addEventListener('change', (e) => { STATE.strength = e.target.value; updateEstimates(); });
        
        const toggles = ['supports','adhesion','rush','qc','epoxy','vapor','hardware','branding','privacy','inserts','uv','assembly','repair','cert','report','sandblast'];
        toggles.forEach(t => {
            const el = id('check-'+t);
            if(el) el.addEventListener('change', (e) => { 
                const key = 'has' + t.charAt(0).toUpperCase() + t.slice(1);
                if(t === 'supports') { STATE.hasSupports = e.target.checked; toggleSupportVis(e.target.checked); }
                else if(t === 'adhesion') STATE.hasAdhesion = e.target.checked;
                else if(t === 'rush') STATE.isRush = e.target.checked;
                else if(t === 'qc') STATE.isQC = e.target.checked;
                else { STATE['is'+t.charAt(0).toUpperCase() + t.slice(1)] = e.target.checked; }
                updateEstimates(); 
            });
        });

        const colors = ['#3b82f6', '#ef4444', '#10b981', '#fbbf24', '#ffffff', '#1e293b', '#6366f1'];
        colors.forEach(c => { const b = document.createElement('div'); b.className = 'w-6 h-6 rounded-full border border-slate-600 cursor-pointer hover:scale-125 transition shadow-lg'; b.style.backgroundColor = c; b.onclick = () => { STATE.color = c; if(mesh) mesh.material.color.set(c); updateEstimates(); }; id('color-picker').appendChild(b); });

        id('btn-wireframe').addEventListener('click', () => { if(wireframe) wireframe.visible = !wireframe.visible; });
        id('btn-reset-view').addEventListener('click', () => { controls.reset(); });
        id('btn-rotate').addEventListener('click', (e) => { STATE.autoRotate = !STATE.autoRotate; controls.autoRotate = STATE.autoRotate; });

        id('btn-goto-cart').addEventListener('click', () => { 
            populateCheckout();
            id('view-configurator').classList.add('-translate-x-full'); 
            setTimeout(() => { id('view-configurator').classList.add('hidden'); id('view-checkout').classList.remove('hidden'); }, 300); 
        });
        id('btn-back').addEventListener('click', () => { 
            id('view-checkout').classList.add('hidden'); 
            id('view-configurator').classList.remove('hidden'); 
            setTimeout(() => id('view-configurator').classList.remove('-translate-x-full'), 10); 
        });

        id('btn-place-order').addEventListener('click', async () => {
            const form = id('checkout-form');
            if(!form.reportValidity()) return;
            
            // Get Warehouse & Payment Data
            const warehouse = document.querySelector('input[name="warehouse"]:checked').value;
            const payMethod = document.querySelector('input[name="pay-method"]:checked').value;
            const utrRef = document.getElementById('utr-input').value;
            
            const btn = id('btn-place-order');
            btn.innerHTML = `UPLOADING...`; btn.disabled = true;
            try {
                const timestamp = Date.now();
                const storageRef = ref(storage, `orders/${timestamp}_${STATE.file.name}`);
                const snap = await uploadBytes(storageRef, STATE.file);
                const url = await getDownloadURL(snap.ref);
                const formData = new FormData(form);
                await addDoc(collection(db, 'orders'), {
                    ...Object.fromEntries(formData.entries()),
                    fileUrl: url, fileName: STATE.file.name,
                    warehouse: warehouse,
                    payment: { method: payMethod, utr: utrRef },
                    specs: {
                        material: STATE.material, infill: STATE.infill, color: STATE.color, scale: STATE.scale, qty: STATE.qty, 
                        finish: STATE.finish, strength: STATE.strength, cost: STATE.cost, rush: STATE.isRush, qc: STATE.isQC,
                        epoxy: STATE.isEpoxy, vapor: STATE.isVapor, hardware: STATE.isHardware, privacy: STATE.isPrivacy,
                        inserts: STATE.isInserts, uv: STATE.isUV, assembly: STATE.isAssembly, repair: STATE.isRepair,
                        // NEW SPEC FIELDS
                        pattern: STATE.infillPattern, cert: STATE.isCert, report: STATE.isReport, sandblast: STATE.isSandblast
                    },
                    status: 'Pending', createdAt: serverTimestamp()
                });
                btn.classList.replace('bg-green-600', 'bg-blue-600'); btn.innerHTML = "‚úÖ ORDER CONFIRMED"; setTimeout(() => window.location.reload(), 2000);
            } catch(e) { console.error(e); btn.innerHTML = "UPLOAD FAILED - RETRY"; btn.disabled = false; id('error-log').innerText = e.message; id('error-log').classList.remove('hidden'); }
        });

        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        animate();
        window.addEventListener('resize', () => { camera.aspect = container.clientWidth / container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
    </script>
</body>

</html>
